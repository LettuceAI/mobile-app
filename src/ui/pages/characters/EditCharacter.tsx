import React from "react";
import { useParams } from "react-router-dom";
import {
  Loader2,
  Plus,
  X,
  Sparkles,
  BookOpen,
  Cpu,
  Image,
  Download,
  Layers,
  Edit2,
  ChevronDown,
  Crop,
  Upload,
  User,
  Settings,
  Volume2,
  EyeOff,
  Check,
  Info,
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { useEditCharacterForm } from "./hooks/useEditCharacterForm";
import { AvatarPicker } from "../../components/AvatarPicker";
import { BottomMenu, MenuSection } from "../../components/BottomMenu";
import { BackgroundPositionModal } from "../../components/BackgroundPositionModal";
import { CharacterExportMenu } from "../../components/CharacterExportMenu";
import { cn, radius, colors, interactive } from "../../design-tokens";
import { getProviderIcon } from "../../../core/utils/providerIcons";
import type { CharacterFileFormat } from "../../../core/storage/characterTransfer";
import {
  listAudioProviders,
  listUserVoices,
  getProviderVoices,
  refreshProviderVoices,
  type AudioProvider,
  type CachedVoice,
  type UserVoice,
} from "../../../core/storage/audioProviders";

const wordCount = (text: string) => {
  const trimmed = text.trim();
  if (!trimmed) return 0;
  return trimmed.split(/\s+/).length;
};

export function EditCharacterPage() {
  const { characterId } = useParams();
  const { state, actions, computed } = useEditCharacterForm(characterId);
  const [expandedSceneId, setExpandedSceneId] = React.useState<string | null>(null);
  const [newSceneEditorOpen, setNewSceneEditorOpen] = React.useState(false);

  // Background image positioning state
  const [pendingBackgroundSrc, setPendingBackgroundSrc] = React.useState<string | null>(null);
  const [showBackgroundChoiceMenu, setShowBackgroundChoiceMenu] = React.useState(false);
  const [showBackgroundPositionModal, setShowBackgroundPositionModal] = React.useState(false);

  // Tab state
  const [activeTab, setActiveTab] = React.useState<"character" | "settings">("character");
  const [showModelMenu, setShowModelMenu] = React.useState(false);
  const [modelSearchQuery, setModelSearchQuery] = React.useState("");
  const [showVoiceMenu, setShowVoiceMenu] = React.useState(false);
  const [voiceSearchQuery, setVoiceSearchQuery] = React.useState("");
  const [exportMenuOpen, setExportMenuOpen] = React.useState(false);
  const tabsId = React.useId();
  const tabPanelId = `${tabsId}-panel`;
  const characterTabId = `${tabsId}-tab-character`;
  const settingsTabId = `${tabsId}-tab-settings`;

  const {
    loading,
    saving,
    exporting,
    error,
    name,
    definition,
    description,
    avatarPath,
    avatarCrop,
    avatarRoundPath,
    backgroundImagePath,
    scenes,
    defaultSceneId,
    newSceneContent,
    newSceneDirection,
    selectedModelId,

    disableAvatarGradient,
    customGradientEnabled,
    customGradientColors,
    customTextColor: _customTextColor,
    customTextSecondary: _customTextSecondary,
    memoryType,
    dynamicMemoryEnabled,
    models,
    loadingModels,
    promptTemplates,
    loadingTemplates,
    systemPromptTemplateId,
    voiceConfig,
    voiceAutoplay,

    editingSceneId,
    editingSceneContent,
    editingSceneDirection,
  } = state;

  const {
    setFields,
    handleSave,
    handleExport,
    addScene,
    deleteScene,
    startEditingScene,
    saveEditedScene,
    cancelEditingScene,
  } = actions;

  const { avatarInitial, canSave } = computed;

  const closeNewSceneEditor = React.useCallback(() => {
    setFields({ newSceneContent: "", newSceneDirection: "" });
    setNewSceneEditorOpen(false);
  }, [setFields]);

  const saveNewScene = React.useCallback(() => {
    if (!newSceneContent.trim()) return;
    addScene();
    setNewSceneEditorOpen(false);
  }, [addScene, newSceneContent]);

  const handleExportFormat = React.useCallback(
    async (format: CharacterFileFormat) => {
      await handleExport(format);
      setExportMenuOpen(false);
    },
    [handleExport],
  );

  const [audioProviders, setAudioProviders] = React.useState<AudioProvider[]>([]);
  const [userVoices, setUserVoices] = React.useState<UserVoice[]>([]);
  const [providerVoices, setProviderVoices] = React.useState<Record<string, CachedVoice[]>>({});
  const [loadingVoices, setLoadingVoices] = React.useState(false);
  const [voiceError, setVoiceError] = React.useState<string | null>(null);
  const [hasLoadedVoices, setHasLoadedVoices] = React.useState(false);

  const buildUserVoiceValue = (id: string) => `user:${id}`;
  const buildProviderVoiceValue = (providerId: string, voiceId: string) =>
    `provider:${providerId}:${voiceId}`;

  const voiceSelectionValue = (() => {
    if (!voiceConfig) return "";
    if (voiceConfig.source === "user" && voiceConfig.userVoiceId) {
      return buildUserVoiceValue(voiceConfig.userVoiceId);
    }
    if (voiceConfig.source === "provider" && voiceConfig.providerId && voiceConfig.voiceId) {
      return buildProviderVoiceValue(voiceConfig.providerId, voiceConfig.voiceId);
    }
    return "";
  })();

  React.useEffect(() => {
    const globalWindow = window as any;
    globalWindow.__saveCharacter = handleSave;
    globalWindow.__saveCharacterCanSave = canSave;
    globalWindow.__saveCharacterSaving = saving;
    return () => {
      delete globalWindow.__saveCharacter;
      delete globalWindow.__saveCharacterCanSave;
      delete globalWindow.__saveCharacterSaving;
    };
  }, [handleSave, canSave, saving]);

  const loadVoices = React.useCallback(async () => {
    setLoadingVoices(true);
    setVoiceError(null);
    try {
      const [providers, voices] = await Promise.all([listAudioProviders(), listUserVoices()]);
      setAudioProviders(providers);
      setUserVoices(voices);

      const voicesByProvider: Record<string, CachedVoice[]> = {};
      await Promise.all(
        providers.map(async (provider) => {
          try {
            if (provider.providerType === "elevenlabs" && provider.apiKey) {
              voicesByProvider[provider.id] = await refreshProviderVoices(provider.id);
            } else {
              voicesByProvider[provider.id] = await getProviderVoices(provider.id);
            }
          } catch (err) {
            console.warn("Failed to refresh provider voices:", err);
            try {
              voicesByProvider[provider.id] = await getProviderVoices(provider.id);
            } catch (fallbackErr) {
              console.warn("Failed to load cached voices:", fallbackErr);
              voicesByProvider[provider.id] = [];
            }
          }
        }),
      );
      setProviderVoices(voicesByProvider);
      setHasLoadedVoices(true);
    } catch (err) {
      console.error("Failed to load voices:", err);
      setVoiceError("Failed to load voices");
    } finally {
      setLoadingVoices(false);
    }
  }, []);

  React.useEffect(() => {
    if (activeTab !== "settings" || hasLoadedVoices) return;
    void loadVoices();
  }, [activeTab, hasLoadedVoices, loadVoices]);

  if (loading) {
    return (
      <div className="flex h-full items-center justify-center">
        <div className="h-8 w-8 animate-spin rounded-full border-2 border-white/10 border-t-white/60" />
      </div>
    );
  }

  return (
    <div className="flex h-full flex-col pb-16 text-gray-200">
      <main
        id={tabPanelId}
        role="tabpanel"
        aria-labelledby={activeTab === "character" ? characterTabId : settingsTabId}
        tabIndex={0}
        className="flex-1 overflow-y-auto px-4"
      >
        <motion.div
          initial={{ opacity: 0, y: 16 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.2, ease: "easeOut" }}
          className="space-y-5 pb-6 pt-4"
        >
          {/* Character Tab Content */}
          {activeTab === "character" && (
            <>
              {/* Error Message */}
              <AnimatePresence>
                {error && (
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -10 }}
                    transition={{ duration: 0.15 }}
                    className="rounded-xl border border-red-400/30 bg-red-400/10 px-4 py-3"
                  >
                    <p className="text-sm text-red-200">{error}</p>
                  </motion.div>
                )}
              </AnimatePresence>

              {/* Avatar Section - CreateCharacter Style */}
              <div className="flex flex-col items-center py-4">
                <div className="relative">
                  <AvatarPicker
                    currentAvatarPath={avatarPath}
                    onAvatarChange={(path) => setFields({ avatarPath: path })}
                    avatarCrop={avatarCrop}
                    onAvatarCropChange={(crop) => setFields({ avatarCrop: crop })}
                    avatarRoundPath={avatarRoundPath}
                    onAvatarRoundChange={(roundPath) => setFields({ avatarRoundPath: roundPath })}
                    placeholder={avatarInitial}
                  />

                  {/* Remove Button - top left */}
                  {avatarPath && (
                    <button
                      type="button"
                      onClick={() =>
                        setFields({ avatarPath: "", avatarCrop: null, avatarRoundPath: null })
                      }
                      className="absolute -top-1 -left-1 z-30 flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-[#1a1a1c] text-white/60 transition hover:bg-red-500/80 hover:border-red-500/50 hover:text-white active:scale-95"
                      aria-label="Remove avatar"
                    >
                      <X size={14} strokeWidth={2.5} />
                    </button>
                  )}
                </div>
                <p className="mt-3 text-xs text-white/40">Tap to add or generate avatar</p>
              </div>

              {/* Name Input */}
              <div className="space-y-2">
                <label className="text-[10px] font-medium uppercase tracking-wide text-white/50">
                  Character Name
                </label>
                <input
                  value={name}
                  onChange={(e) => setFields({ name: e.target.value })}
                  placeholder="Enter character name..."
                  className="w-full rounded-xl border border-white/10 bg-black/20 px-4 py-3 text-base text-white placeholder-white/40 transition focus:border-white/25 focus:outline-none"
                />
              </div>
            </>
          )}

          {/* Settings Tab Content */}
          {activeTab === "settings" && (
            <>
              {/* Avatar Gradient Toggle */}
              {avatarPath && (
                <div className="space-y-3">
                  <label className="flex cursor-pointer items-center justify-between rounded-xl border border-white/10 bg-black/20 px-4 py-3 transition hover:bg-black/30">
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <Sparkles className="h-4 w-4 text-emerald-400" />
                        <p className="text-sm font-medium text-white">Avatar Gradient</p>
                      </div>
                      <p className="mt-0.5 text-xs text-white/50">
                        Generate colorful gradients from avatar colors
                      </p>
                    </div>
                    <div className="relative ml-3">
                      <input
                        type="checkbox"
                        checked={!disableAvatarGradient}
                        onChange={(e) => setFields({ disableAvatarGradient: !e.target.checked })}
                        className="peer sr-only"
                      />
                      <div className="h-6 w-11 rounded-full bg-white/20 transition peer-checked:bg-emerald-500/80"></div>
                      <div className="absolute left-1 top-1 h-4 w-4 rounded-full bg-white transition peer-checked:translate-x-5"></div>
                    </div>
                  </label>
                </div>
              )}

              {/* Custom Gradient Override */}
              {avatarPath && (
                <div className="space-y-3">
                  <div className="rounded-xl border border-white/10 bg-black/20 px-4 py-3">
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2">
                          <Sparkles className="h-4 w-4 text-purple-400" />
                          <p className="text-sm font-medium text-white">Custom Gradient</p>
                        </div>
                        <p className="mt-0.5 text-xs text-white/50">
                          Override auto-detected colors with your own
                        </p>
                      </div>
                      <label className="relative ml-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={customGradientEnabled}
                          onChange={(e) => {
                            if (e.target.checked) {
                              // Enable - set default colors if none exist
                              const colors =
                                customGradientColors.length > 0
                                  ? customGradientColors
                                  : ["#4f46e5", "#7c3aed"];
                              setFields({
                                customGradientEnabled: true,
                                customGradientColors: colors,
                              });
                            } else {
                              // Disable but preserve colors
                              setFields({ customGradientEnabled: false });
                            }
                          }}
                          className="peer sr-only"
                        />
                        <div className="h-6 w-11 rounded-full bg-white/20 transition peer-checked:bg-purple-500/80"></div>
                        <div className="absolute left-1 top-1 h-4 w-4 rounded-full bg-white transition peer-checked:translate-x-5"></div>
                      </label>
                    </div>

                    {/* Color Pickers - shown when custom gradient enabled */}
                    {customGradientEnabled && (
                      <div className="mt-4 space-y-3 border-t border-white/10 pt-4">
                        {/* Gradient Preview */}
                        <div
                          className="h-16 w-full rounded-lg"
                          style={{
                            background:
                              customGradientColors.length >= 3
                                ? `linear-gradient(135deg, ${customGradientColors[0]}, ${customGradientColors[2]}, ${customGradientColors[1]})`
                                : customGradientColors.length >= 2
                                  ? `linear-gradient(135deg, ${customGradientColors[0]}, ${customGradientColors[1]})`
                                  : customGradientColors[0],
                          }}
                        />

                        {/* Color 1 */}
                        <div className="flex items-center gap-3">
                          <label className="text-xs text-white/50 w-12">Start</label>
                          <div className="relative shrink-0">
                            <input
                              type="color"
                              value={customGradientColors[0] || "#4f46e5"}
                              onChange={(e) => {
                                const newColors = [...customGradientColors];
                                newColors[0] = e.target.value;
                                setFields({ customGradientColors: newColors });
                              }}
                              className="h-10 w-10 cursor-pointer rounded-lg border-2 border-white/20 p-0.5"
                              style={{ backgroundColor: customGradientColors[0] || "#4f46e5" }}
                            />
                          </div>
                          <input
                            type="text"
                            value={customGradientColors[0] || ""}
                            onChange={(e) => {
                              const newColors = [...customGradientColors];
                              newColors[0] = e.target.value;
                              setFields({ customGradientColors: newColors });
                            }}
                            placeholder="#4f46e5"
                            className="flex-1 rounded-lg border border-white/10 bg-black/50 px-3 py-2 text-sm font-mono text-white placeholder:text-white/30 focus:border-purple-500/50 focus:outline-none"
                          />
                        </div>

                        {/* Middle Color (optional) */}
                        {customGradientColors.length >= 3 ? (
                          <div className="flex items-center gap-3">
                            <label className="text-xs text-white/50 w-12">Mid</label>
                            <div className="relative shrink-0">
                              <input
                                type="color"
                                value={customGradientColors[2] || "#a855f7"}
                                onChange={(e) => {
                                  const newColors = [...customGradientColors];
                                  newColors[2] = e.target.value;
                                  setFields({ customGradientColors: newColors });
                                }}
                                className="h-10 w-10 cursor-pointer rounded-lg border-2 border-white/20 p-0.5"
                                style={{ backgroundColor: customGradientColors[2] || "#a855f7" }}
                              />
                            </div>
                            <input
                              type="text"
                              value={customGradientColors[2] || ""}
                              onChange={(e) => {
                                const newColors = [...customGradientColors];
                                newColors[2] = e.target.value;
                                setFields({ customGradientColors: newColors });
                              }}
                              placeholder="#a855f7"
                              className="flex-1 rounded-lg border border-white/10 bg-black/50 px-3 py-2 text-sm font-mono text-white placeholder:text-white/30 focus:border-purple-500/50 focus:outline-none"
                            />
                            <button
                              type="button"
                              onClick={() => {
                                // Remove middle color - reorder so End stays at index 1
                                const newColors = [
                                  customGradientColors[0],
                                  customGradientColors[1],
                                ];
                                setFields({ customGradientColors: newColors });
                              }}
                              className="shrink-0 text-xs text-red-400 hover:text-red-300"
                            >
                              ✕
                            </button>
                          </div>
                        ) : (
                          <button
                            type="button"
                            onClick={() => {
                              // Add middle color between Start and End
                              const newColors = [
                                customGradientColors[0],
                                customGradientColors[1],
                                "#a855f7",
                              ];
                              setFields({ customGradientColors: newColors });
                            }}
                            className="text-xs text-purple-400 hover:text-purple-300 py-1"
                          >
                            + Add middle color
                          </button>
                        )}

                        {/* Color 2 (End) */}
                        <div className="flex items-center gap-3">
                          <label className="text-xs text-white/50 w-12">End</label>
                          <div className="relative shrink-0">
                            <input
                              type="color"
                              value={customGradientColors[1] || "#7c3aed"}
                              onChange={(e) => {
                                const newColors = [...customGradientColors];
                                newColors[1] = e.target.value;
                                setFields({ customGradientColors: newColors });
                              }}
                              className="h-10 w-10 cursor-pointer rounded-lg border-2 p-0.5"
                              style={{ backgroundColor: customGradientColors[1] || "#7c3aed" }}
                            />
                          </div>
                          <input
                            type="text"
                            value={customGradientColors[1] || ""}
                            onChange={(e) => {
                              const newColors = [...customGradientColors];
                              newColors[1] = e.target.value;
                              setFields({ customGradientColors: newColors });
                            }}
                            placeholder="#7c3aed"
                            className="flex-1 rounded-lg border border-white/10 bg-black/50 px-3 py-2 text-sm font-mono text-white placeholder:text-white/30 focus:border-purple-500/50 focus:outline-none"
                          />
                        </div>

                        {/* Optional: Text color override hint */}
                        <p className="text-[10px] text-white/40 mt-2">
                          Text colors are auto-calculated based on gradient brightness
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Background Image Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-purple-400/30 bg-purple-400/10 p-1.5">
                    <Image className="h-4 w-4 text-purple-400" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">Chat Background</h3>
                  <span className="text-xs text-white/40">(Optional)</span>
                </div>

                <div className="overflow-hidden rounded-xl border border-white/10 bg-black/20">
                  {backgroundImagePath ? (
                    <div className="relative">
                      <img
                        src={backgroundImagePath}
                        alt="Background preview"
                        className="h-32 w-full object-cover"
                      />
                      <div className="absolute inset-0 bg-black/30 flex items-center justify-center">
                        <span className="text-xs text-white/80 bg-black/50 px-2 py-1 rounded">
                          Background Preview
                        </span>
                      </div>
                      <button
                        type="button"
                        onClick={() => setFields({ backgroundImagePath: "" })}
                        className="absolute top-2 right-2 rounded-full border border-white/20 bg-black/50 p-1 text-white/70 transition hover:bg-black/70 active:scale-95"
                        aria-label="Remove background image"
                      >
                        <X size={14} />
                      </button>
                    </div>
                  ) : (
                    <label className="flex h-32 cursor-pointer flex-col items-center justify-center gap-2 transition hover:bg-white/5">
                      <div className="rounded-lg border border-white/10 bg-white/5 p-2">
                        <Image size={20} className="text-white/40" />
                      </div>
                      <div className="text-center">
                        <p className="text-sm text-white/70">Add Background Image</p>
                        <p className="text-xs text-white/40">Tap to select an image</p>
                      </div>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => {
                          const file = e.target.files?.[0];
                          if (!file) return;
                          const reader = new FileReader();
                          reader.onload = () => {
                            const dataUrl = reader.result as string;
                            setPendingBackgroundSrc(dataUrl);
                            setShowBackgroundChoiceMenu(true);
                          };
                          reader.readAsDataURL(file);
                          e.target.value = "";
                        }}
                        className="hidden"
                      />
                    </label>
                  )}
                </div>
                <p className="text-xs text-white/50">
                  Optional background image for chat conversations with this character
                </p>
              </div>
            </>
          )}

          {/* Character Tab: Personality & Scenes */}
          {activeTab === "character" && (
            <>
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-white/10 bg-white/5 p-1.5">
                    <Info className="h-4 w-4 text-white/60" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">Description</h3>
                </div>
                <textarea
                  value={description}
                  onChange={(e) => setFields({ description: e.target.value })}
                  rows={3}
                  placeholder="Short summary shown in lists and cards..."
                  className="w-full resize-none rounded-xl border border-white/10 bg-black/20 px-3.5 py-3 text-sm leading-relaxed text-white placeholder-white/40 transition focus:border-white/25 focus:outline-none"
                />
                <p className="text-xs text-white/50">
                  Optional short description for display purposes.
                </p>
              </div>

              {/* Personality Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-emerald-400/30 bg-emerald-400/10 p-1.5">
                    <Sparkles className="h-4 w-4 text-emerald-400" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">Definition</h3>
                </div>
                <textarea
                  value={definition}
                  onChange={(e) => setFields({ definition: e.target.value })}
                  rows={8}
                  placeholder="Describe who this character is, their personality, background, speaking style, and how they should interact..."
                  className="w-full resize-none rounded-xl border border-white/10 bg-black/20 px-3.5 py-3 text-sm leading-relaxed text-white placeholder-white/40 transition focus:border-white/25 focus:outline-none"
                />
                <div className="flex justify-between text-[11px] text-white/50">
                  <span>Be detailed to create a unique personality</span>
                  <span>{wordCount(definition)} words</span>
                </div>
                <div className="rounded-xl border border-blue-400/20 bg-blue-400/10 px-3.5 py-3">
                  <div className="text-[11px] font-medium text-blue-200">
                    Available Placeholders
                  </div>
                  <div className="mt-2 space-y-1 text-xs text-blue-200/70">
                    <div>
                      <code className="text-emerald-300">{"{{char}}"}</code> - Character name
                    </div>
                    <div>
                      <code className="text-emerald-300">{"{{user}}"}</code> - Persona name
                      (preferred, empty if none)
                    </div>
                    <div>
                      <code className="text-emerald-300">{"{{persona}}"}</code> - Persona name
                      (alias)
                    </div>
                  </div>
                </div>
              </div>

              {/* Starting Scenes Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-blue-400/30 bg-blue-400/10 p-1.5">
                    <BookOpen className="h-4 w-4 text-blue-400" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">Starting Scenes</h3>
                  {scenes.length > 0 && (
                    <span className="ml-auto rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-xs text-white/70">
                      {scenes.length}
                    </span>
                  )}
                </div>

                {/* Existing Scenes */}
                <AnimatePresence mode="popLayout">
                  {scenes.length > 0 && (
                    <motion.div layout className="space-y-2">
                      {scenes.map((scene, index) => {
                        const isDefault = defaultSceneId === scene.id;
                        const isExpanded = expandedSceneId === scene.id;

                        return (
                          <motion.div
                            key={scene.id}
                            layout
                            initial={{ opacity: 0, scale: 0.95 }}
                            animate={{ opacity: 1, scale: 1 }}
                            exit={{ opacity: 0, scale: 0.9, x: -20 }}
                            transition={{ duration: 0.15 }}
                            className={`overflow-hidden rounded-xl border ${
                              isDefault
                                ? "border-emerald-400/30 bg-emerald-400/5"
                                : "border-white/10 bg-white/5"
                            }`}
                          >
                            {/* Scene Header - clickable to expand/collapse */}
                            <button
                              onClick={() => setExpandedSceneId(isExpanded ? null : scene.id)}
                              className={`flex w-full items-center gap-2 border-b px-3.5 py-2.5 text-left ${
                                isDefault
                                  ? "border-emerald-400/20 bg-emerald-400/10"
                                  : "border-white/10 bg-white/5"
                              }`}
                            >
                              {/* Scene number badge */}
                              <div
                                className={`flex h-6 w-6 shrink-0 items-center justify-center rounded-lg border text-xs font-medium ${
                                  isDefault
                                    ? "border-emerald-400/40 bg-emerald-400/20 text-emerald-300"
                                    : "border-white/10 bg-white/5 text-white/60"
                                }`}
                              >
                                {index + 1}
                              </div>

                              {/* Default badge */}
                              {isDefault && (
                                <div className="flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-400/20 px-2 py-0.5">
                                  <div className="h-1.5 w-1.5 rounded-full bg-emerald-400" />
                                  <span className="text-[10px] font-medium text-emerald-200">
                                    Default
                                  </span>
                                </div>
                              )}

                              {/* Direction indicator */}
                              {scene.direction && (
                                <div
                                  className="flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-1.5 py-0.5"
                                  title="Has scene direction"
                                >
                                  <EyeOff className="h-3 w-3 text-white/40" />
                                </div>
                              )}

                              {/* Preview text when collapsed */}
                              {!isExpanded && (
                                <span className="flex-1 truncate text-sm text-white/50">
                                  {scene.content.slice(0, 50)}
                                  {scene.content.length > 50 ? "..." : ""}
                                </span>
                              )}

                              {/* Expand indicator */}
                              <ChevronDown
                                className={cn(
                                  "h-4 w-4 text-white/40 transition-transform ml-auto",
                                  isExpanded && "rotate-180",
                                )}
                              />
                            </button>

                            {/* Scene Content - collapsible */}
                            <AnimatePresence>
                              {isExpanded && (
                                <motion.div
                                  initial={{ height: 0, opacity: 0 }}
                                  animate={{ height: "auto", opacity: 1 }}
                                  exit={{ height: 0, opacity: 0 }}
                                  transition={{ duration: 0.2 }}
                                  className="overflow-hidden"
                                >
                                  <div className="p-3.5">
                                    <div className="space-y-3">
                                      <p className="text-sm leading-relaxed text-white/90">
                                        {scene.content}
                                      </p>

                                      {/* Scene Direction (if set) */}
                                      {scene.direction && (
                                        <div className="pt-2 border-t border-white/5">
                                          <p className="text-[10px] font-medium text-white/40 mb-1">
                                            Scene Direction
                                          </p>
                                          <p className="text-xs leading-relaxed text-white/50 italic">
                                            {scene.direction}
                                          </p>
                                        </div>
                                      )}

                                      {/* Actions when expanded */}
                                      <div className="flex items-center gap-2 pt-2 border-t border-white/5">
                                        {!isDefault && (
                                          <button
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setFields({ defaultSceneId: scene.id });
                                            }}
                                            className="rounded-lg border border-white/10 bg-white/5 px-2.5 py-1.5 text-xs font-medium text-white/60 transition active:scale-95 active:bg-white/10"
                                          >
                                            Set as Default
                                          </button>
                                        )}
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            setNewSceneEditorOpen(false);
                                            startEditingScene(scene);
                                          }}
                                          className="rounded-lg border border-white/10 bg-white/5 p-1.5 text-white/60 transition active:scale-95 active:bg-white/10"
                                          aria-label={`Edit scene ${index + 1}`}
                                        >
                                          <Edit2 className="h-3.5 w-3.5" />
                                        </button>
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            deleteScene(scene.id);
                                          }}
                                          className="rounded-lg border border-white/10 bg-white/5 p-1.5 text-white/50 transition active:bg-red-400/10 active:text-red-400"
                                          aria-label={`Delete scene ${index + 1}`}
                                        >
                                          <X className="h-3.5 w-3.5" />
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                </motion.div>
                              )}
                            </AnimatePresence>
                          </motion.div>
                        );
                      })}
                    </motion.div>
                  )}
                </AnimatePresence>

                {/* Add New Scene */}
                <motion.div layout className="space-y-2">
                  <div className="rounded-xl border border-white/10 bg-black/20 px-3.5 py-3">
                    <div className="text-sm font-medium text-white">New starting scene</div>
                    <p className="mt-1 text-xs text-white/50">
                      Create a scenario and optional direction for the opening moment.
                    </p>
                    <div className="mt-3 flex items-center gap-2">
                      <motion.button
                        onClick={() => setNewSceneEditorOpen(true)}
                        whileTap={{ scale: 0.97 }}
                        className="flex items-center gap-2 rounded-xl border border-blue-400/40 bg-blue-400/20 px-3.5 py-2 text-sm font-medium text-blue-100 transition active:bg-blue-400/30"
                      >
                        <Plus className="h-4 w-4" />
                        Create Scene
                      </motion.button>
                      {newSceneContent.trim() && (
                        <button
                          type="button"
                          onClick={() => setNewSceneEditorOpen(true)}
                          className="text-xs text-white/50 transition hover:text-white/70"
                        >
                          Continue draft
                        </button>
                      )}
                    </div>
                  </div>
                </motion.div>

                <p className="text-xs text-white/50">
                  Create multiple starting scenarios. One will be selected when starting a new chat.
                </p>
              </div>
            </>
          )}

          {/* Settings Tab: Model & Memory */}
          {activeTab === "settings" && (
            <>
              {/* Model Selection Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-purple-400/30 bg-purple-400/10 p-1.5">
                    <Cpu className="h-4 w-4 text-purple-400" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">Default Model</h3>
                  <span className="ml-auto text-xs text-white/40">(Optional)</span>
                </div>

                {loadingModels ? (
                  <div className="flex items-center gap-2 rounded-xl border border-white/10 bg-black/20 px-4 py-3">
                    <Loader2 className="h-4 w-4 animate-spin text-white/50" />
                    <span className="text-sm text-white/50">Loading models...</span>
                  </div>
                ) : models.length > 0 ? (
                  <button
                    type="button"
                    onClick={() => setShowModelMenu(true)}
                    className="flex w-full items-center justify-between rounded-xl border border-white/10 bg-black/20 px-3.5 py-3 text-left transition hover:bg-black/30 focus:border-white/25 focus:outline-none"
                  >
                    <div className="flex items-center gap-2">
                      {selectedModelId ? (
                        getProviderIcon(
                          models.find((m) => m.id === selectedModelId)?.providerId || "",
                        )
                      ) : (
                        <Cpu className="h-5 w-5 text-white/40" />
                      )}
                      <span
                        className={`text-sm ${selectedModelId ? "text-white" : "text-white/50"}`}
                      >
                        {selectedModelId
                          ? models.find((m) => m.id === selectedModelId)?.displayName ||
                            "Selected Model"
                          : "Use global default model"}
                      </span>
                    </div>
                    <ChevronDown className="h-4 w-4 text-white/40" />
                  </button>
                ) : (
                  <div className="rounded-xl border border-white/10 bg-black/20 px-4 py-3">
                    <p className="text-sm text-white/50">No models available</p>
                  </div>
                )}
                <p className="text-xs text-white/50">
                  Override the default AI model for this character
                </p>
              </div>

              {/* System Prompt Template Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-cyan-400/30 bg-cyan-400/10 p-1.5">
                    <BookOpen className="h-4 w-4 text-cyan-400" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">System Prompt</h3>
                  <span className="ml-auto text-xs text-white/40">(Optional)</span>
                </div>

                {loadingTemplates ? (
                  <div className="flex items-center gap-2 rounded-xl border border-white/10 bg-black/20 px-4 py-3">
                    <Loader2 className="h-4 w-4 animate-spin text-white/50" />
                    <span className="text-sm text-white/50">Loading templates...</span>
                  </div>
                ) : promptTemplates.length > 0 ? (
                  <select
                    value={systemPromptTemplateId || ""}
                    onChange={(e) => setFields({ systemPromptTemplateId: e.target.value || null })}
                    className="w-full appearance-none rounded-xl border border-white/10 bg-black/20 px-3.5 py-3 text-sm text-white transition focus:border-white/25 focus:outline-none"
                  >
                    <option value="">Use default system prompt</option>
                    {promptTemplates.map((template) => (
                      <option key={template.id} value={template.id}>
                        {template.name}
                      </option>
                    ))}
                  </select>
                ) : (
                  <div className="rounded-xl border border-white/10 bg-black/20 px-4 py-3">
                    <p className="text-sm text-white/50">No templates available</p>
                    <p className="text-xs text-white/40 mt-1">
                      Create templates in Settings → Prompts
                    </p>
                  </div>
                )}
                <p className="text-xs text-white/50">
                  Override the default system prompt for this character
                </p>
              </div>

              {/* Voice Selection */}
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-emerald-400/30 bg-emerald-400/10 p-1.5">
                    <Volume2 className="h-4 w-4 text-emerald-300" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">Voice</h3>
                  <span className="ml-auto text-xs text-white/40">(Optional)</span>
                </div>

                {loadingVoices ? (
                  <div className="flex items-center gap-2 rounded-xl border border-white/10 bg-black/20 px-4 py-3">
                    <Loader2 className="h-4 w-4 animate-spin text-white/50" />
                    <span className="text-sm text-white/50">Loading voices...</span>
                  </div>
                ) : (
                  <button
                    type="button"
                    onClick={() => setShowVoiceMenu(true)}
                    className="flex w-full items-center justify-between rounded-xl border border-white/10 bg-black/20 px-3.5 py-3 text-left transition hover:bg-black/30 focus:border-white/25 focus:outline-none"
                  >
                    <div className="flex items-center gap-2">
                      <Volume2 className="h-5 w-5 text-white/40" />
                      <span
                        className={`text-sm ${voiceSelectionValue ? "text-white" : "text-white/50"}`}
                      >
                        {voiceSelectionValue
                          ? (() => {
                              if (voiceConfig?.source === "user") {
                                const v = userVoices.find(
                                  (uv) => uv.id === voiceConfig.userVoiceId,
                                );
                                return v?.name || "Custom Voice";
                              }
                              if (voiceConfig?.source === "provider") {
                                const pv = providerVoices[voiceConfig.providerId || ""]?.find(
                                  (pv) => pv.voiceId === voiceConfig.voiceId,
                                );
                                return pv?.name || "Provider Voice";
                              }
                              return "Selected Voice";
                            })()
                          : "No voice assigned"}
                      </span>
                    </div>
                    <ChevronDown className="h-4 w-4 text-white/40" />
                  </button>
                )}

                {voiceError && <p className="text-xs font-medium text-rose-300">{voiceError}</p>}
                {!loadingVoices && audioProviders.length === 0 && userVoices.length === 0 && (
                  <p className="text-xs text-white/40">Add voices in Settings → Voices</p>
                )}
                <p className="text-xs text-white/50">
                  Assign a voice for future text-to-speech playback
                </p>
                <div
                  className={cn(
                    "flex items-center justify-between rounded-xl border border-white/10 bg-black/20 px-4 py-3",
                    !voiceConfig && "opacity-50",
                  )}
                >
                  <div>
                    <p className="text-sm font-medium text-white">Autoplay voice</p>
                    <p className="mt-1 text-xs text-white/50">
                      {voiceConfig
                        ? "Play this character's replies automatically"
                        : "Select a voice first"}
                    </p>
                  </div>
                  <div className="flex items-center">
                    <input
                      id="character-voice-autoplay"
                      type="checkbox"
                      checked={voiceAutoplay}
                      onChange={() => setFields({ voiceAutoplay: !voiceAutoplay })}
                      disabled={!voiceConfig}
                      className="peer sr-only"
                    />
                    <label
                      htmlFor="character-voice-autoplay"
                      className={`relative inline-flex h-6 w-11 shrink-0 rounded-full transition-all ${
                        voiceAutoplay ? "bg-emerald-500" : "bg-white/20"
                      } ${voiceConfig ? "cursor-pointer" : "cursor-not-allowed"}`}
                    >
                      <span
                        className={`inline-block h-5 w-5 mt-0.5 transform rounded-full bg-white transition ${
                          voiceAutoplay ? "translate-x-5" : "translate-x-0.5"
                        }`}
                      />
                    </label>
                  </div>
                </div>
              </div>

              {/* Memory Mode */}
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="rounded-lg border border-amber-400/30 bg-amber-400/10 p-1.5">
                    <Layers className="h-4 w-4 text-amber-300" />
                  </div>
                  <h3 className="text-sm font-semibold text-white">Memory Mode</h3>
                  {!dynamicMemoryEnabled && (
                    <span className="ml-auto text-xs text-white/40">
                      Enable Dynamic Memory to switch
                    </span>
                  )}
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <button
                    type="button"
                    onClick={() => setFields({ memoryType: "manual" })}
                    className={`rounded-xl border px-3.5 py-3 text-left transition ${
                      memoryType === "manual"
                        ? "border-emerald-400/40 bg-emerald-400/15 text-emerald-50 shadow-[0_0_0_1px_rgba(16,185,129,0.25)]"
                        : "border-white/10 bg-black/20 text-white/70 hover:border-white/20 hover:bg-black/30"
                    }`}
                  >
                    <p className="text-sm font-semibold">Manual Memory</p>
                    <p className="mt-1 text-xs text-white/60">
                      Manage notes yourself (current system).
                    </p>
                  </button>
                  <button
                    type="button"
                    disabled={!dynamicMemoryEnabled}
                    onClick={() => dynamicMemoryEnabled && setFields({ memoryType: "dynamic" })}
                    className={`rounded-xl border px-3.5 py-3 text-left transition ${
                      memoryType === "dynamic" && dynamicMemoryEnabled
                        ? "border-blue-400/50 bg-blue-500/20 text-blue-50 shadow-[0_0_0_1px_rgba(96,165,250,0.3)]"
                        : "border-white/10 bg-black/15 text-white/60"
                    } ${!dynamicMemoryEnabled ? "cursor-not-allowed opacity-50" : "hover:border-white/20 hover:bg-black/25"}`}
                  >
                    <p className="text-sm font-semibold">Dynamic Memory</p>
                    <p className="mt-1 text-xs text-white/60">
                      Automatic summaries when enabled globally.
                    </p>
                  </button>
                </div>
                <p className="text-xs text-white/50">
                  Dynamic Memory must be turned on in Advanced settings; otherwise manual memory is
                  used.
                </p>
              </div>
            </>
          )}

          {/* Export Button - Character Tab */}
          {activeTab === "character" && (
            <motion.button
              onClick={() => setExportMenuOpen(true)}
              disabled={exporting}
              whileTap={{ scale: exporting ? 1 : 0.98 }}
              className="w-full rounded-xl border border-blue-400/40 bg-blue-400/20 px-4 py-3.5 text-sm font-semibold text-blue-100 transition hover:bg-blue-400/30 disabled:opacity-50"
            >
              {exporting ? (
                <span className="flex items-center justify-center gap-2">
                  <Loader2 className="h-4 w-4 animate-spin" />
                  Exporting...
                </span>
              ) : (
                <span className="flex items-center justify-center gap-2">
                  <Download className="h-4 w-4" />
                  Export Character
                </span>
              )}
            </motion.button>
          )}
        </motion.div>
      </main>

      <CharacterExportMenu
        isOpen={exportMenuOpen}
        onClose={() => setExportMenuOpen(false)}
        onSelect={handleExportFormat}
        exporting={exporting}
      />

      {/* Bottom Tab Bar */}
      <div
        className={cn(
          "fixed bottom-0 left-0 right-0 border-t px-3 pb-[calc(env(safe-area-inset-bottom)+12px)] pt-3",
          colors.glass.strong,
        )}
      >
        <div
          role="tablist"
          aria-label="Character editor tabs"
          className={cn(radius.lg, "grid grid-cols-2 gap-2 p-1", colors.surface.elevated)}
        >
          {[
            { id: "character" as const, icon: User, label: "Character" },
            { id: "settings" as const, icon: Settings, label: "Settings" },
          ].map(({ id, icon: Icon, label }) => (
            <button
              key={id}
              type="button"
              onClick={() => setActiveTab(id)}
              role="tab"
              id={id === "character" ? characterTabId : settingsTabId}
              aria-selected={activeTab === id}
              aria-controls={tabPanelId}
              className={cn(
                radius.md,
                "px-3 py-2.5 text-sm font-semibold transition flex items-center justify-center gap-2",
                interactive.active.scale,
                activeTab === id
                  ? "bg-white/10 text-white"
                  : cn(colors.text.tertiary, "hover:text-white"),
              )}
            >
              <Icon size={16} className="block" />
              <span className="pt-1">{label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Edit/New Scene Fullscreen Panel */}
      <AnimatePresence>
        {(editingSceneId !== null || newSceneEditorOpen) && (
          <motion.div
            className="fixed inset-0 z-50 flex h-full flex-col bg-black/90 backdrop-blur-sm"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 20 }}
            transition={{ duration: 0.2 }}
          >
            <div className="flex items-center justify-between border-b border-white/10 px-4 py-3">
              <div className="text-base font-semibold text-white">
                {editingSceneId !== null ? "Edit Scene" : "New Scene"}
              </div>
              <div className="flex items-center gap-2">
                <button
                  type="button"
                  onClick={editingSceneId !== null ? cancelEditingScene : closeNewSceneEditor}
                  className="rounded-full border border-white/10 px-3 py-1.5 text-xs font-medium text-white/70 transition hover:bg-white/10 hover:text-white"
                >
                  Close
                </button>
                <button
                  type="button"
                  onClick={editingSceneId !== null ? saveEditedScene : saveNewScene}
                  disabled={
                    editingSceneId !== null ? !editingSceneContent.trim() : !newSceneContent.trim()
                  }
                  className={cn(
                    "rounded-full px-3 py-1.5 text-xs font-semibold text-white transition",
                    "bg-linear-to-r from-emerald-500 to-green-500",
                    "hover:from-emerald-400 hover:to-green-400",
                    "disabled:cursor-not-allowed disabled:opacity-50",
                  )}
                >
                  {editingSceneId !== null ? "Save" : "Add"}
                </button>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto px-4 pb-6 pt-4">
              <div className="space-y-6">
                <div className="space-y-2">
                  <div className="text-sm font-medium text-white/80">Scene</div>
                  <textarea
                    value={editingSceneId !== null ? editingSceneContent : newSceneContent}
                    onChange={(e) =>
                      setFields(
                        editingSceneId !== null
                          ? { editingSceneContent: e.target.value }
                          : { newSceneContent: e.target.value },
                      )
                    }
                    rows={14}
                    className="min-h-[40vh] w-full resize-none rounded-2xl border border-white/10 bg-black/40 px-4 py-4 text-sm leading-relaxed text-white placeholder-white/40 transition focus:border-white/20 focus:outline-none"
                    placeholder="Enter scene content..."
                  />
                  <div className="flex items-center justify-between text-[11px] text-white/40">
                    <span>
                      {wordCount(editingSceneId !== null ? editingSceneContent : newSceneContent)}{" "}
                      words
                    </span>
                    <span>
                      Use <code className="text-emerald-300">{"{{char}}"}</code>,{" "}
                      <code className="text-emerald-300">{"{{user}}"}</code>
                    </span>
                  </div>
                </div>

                <div className="space-y-2">
                  <div className="flex items-center gap-1.5 text-sm font-medium text-white/80">
                    <EyeOff className="h-4 w-4 text-white/50" />
                    Scene Direction
                  </div>
                  <textarea
                    value={editingSceneId !== null ? editingSceneDirection : newSceneDirection}
                    onChange={(e) =>
                      setFields(
                        editingSceneId !== null
                          ? { editingSceneDirection: e.target.value }
                          : { newSceneDirection: e.target.value },
                      )
                    }
                    rows={6}
                    className="min-h-[18vh] w-full resize-none rounded-2xl border border-white/10 bg-black/35 px-4 py-3 text-sm leading-relaxed text-white placeholder-white/30 transition focus:border-white/20 focus:outline-none"
                    placeholder="e.g., 'The hostage will be rescued' or 'Build tension gradually'"
                  />
                  <p className="text-[11px] text-white/40">
                    Hidden guidance for the AI on how this scene should unfold.
                  </p>
                </div>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Background Upload Choice Menu */}
      <BottomMenu
        isOpen={showBackgroundChoiceMenu}
        onClose={() => {
          setShowBackgroundChoiceMenu(false);
          setPendingBackgroundSrc(null);
        }}
        title=""
      >
        <div className="space-y-4 p-2">
          <div className="text-center">
            <h3 className="text-lg font-semibold text-white">Background Image</h3>
            <p className="text-sm text-white/50">Choose how to add your image</p>
          </div>

          <div className="space-y-2">
            {/* Quick Upload Option */}
            <button
              onClick={() => {
                if (pendingBackgroundSrc) {
                  setFields({ backgroundImagePath: pendingBackgroundSrc });
                }
                setShowBackgroundChoiceMenu(false);
                setPendingBackgroundSrc(null);
              }}
              className="flex w-full items-center gap-4 rounded-xl border border-white/10 bg-white/5 p-2 transition hover:bg-white/10 active:scale-[0.98]"
            >
              <div className="flex h-12 w-12 items-center justify-center rounded-lg border border-emerald-400/30 bg-emerald-500/15 text-emerald-300">
                <Upload size={20} />
              </div>
              <div className="flex-1 text-left">
                <p className="font-medium text-white">Quick Upload</p>
                <p className="text-xs text-white/50">Use full image without cropping</p>
              </div>
            </button>

            {/* Position & Crop Option */}
            <button
              onClick={() => {
                setShowBackgroundChoiceMenu(false);
                setShowBackgroundPositionModal(true);
              }}
              className="flex w-full items-center gap-4 rounded-xl border border-white/10 bg-white/5 p-4 transition hover:bg-white/10 active:scale-[0.98]"
            >
              <div className="flex h-12 w-12 items-center justify-center rounded-lg border border-cyan-400/30 bg-cyan-500/15 text-cyan-300">
                <Crop size={20} />
              </div>
              <div className="flex-1 text-left">
                <p className="font-medium text-white">Position & Crop</p>
                <p className="text-xs text-white/50">Adjust to fit portrait view</p>
              </div>
            </button>
          </div>
        </div>
      </BottomMenu>

      {/* Background Position Modal */}
      {pendingBackgroundSrc && (
        <BackgroundPositionModal
          isOpen={showBackgroundPositionModal}
          onClose={() => {
            setShowBackgroundPositionModal(false);
            setPendingBackgroundSrc(null);
          }}
          imageSrc={pendingBackgroundSrc}
          onConfirm={(croppedDataUrl) => {
            setFields({ backgroundImagePath: croppedDataUrl });
            setPendingBackgroundSrc(null);
          }}
        />
      )}

      {/* Model Selection BottomMenu */}
      <BottomMenu
        isOpen={showModelMenu}
        onClose={() => {
          setShowModelMenu(false);
          setModelSearchQuery("");
        }}
        title="Select Model"
      >
        <div className="space-y-4">
          <div className="relative">
            <input
              type="text"
              value={modelSearchQuery}
              onChange={(e) => setModelSearchQuery(e.target.value)}
              placeholder="Search models..."
              className="w-full rounded-xl border border-white/10 bg-black/30 px-4 py-2.5 pl-10 text-sm text-white placeholder-white/40 focus:border-white/20 focus:outline-none"
            />
            <svg
              className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-white/40"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>
          <div className="space-y-2 max-h-[50vh] overflow-y-auto">
            <button
              onClick={() => {
                setFields({ selectedModelId: null });
                setShowModelMenu(false);
                setModelSearchQuery("");
              }}
              className={cn(
                "flex w-full items-center gap-3 rounded-xl border px-3.5 py-3 text-left transition",
                !selectedModelId
                  ? "border-emerald-400/40 bg-emerald-400/10"
                  : "border-white/10 bg-white/5 hover:bg-white/10",
              )}
            >
              <Cpu className="h-5 w-5 text-white/40" />
              <span className="text-sm text-white">Use global default model</span>
              {!selectedModelId && <Check className="h-4 w-4 ml-auto text-emerald-400" />}
            </button>
            {models
              .filter((m) => {
                if (!modelSearchQuery) return true;
                const q = modelSearchQuery.toLowerCase();
                return (
                  m.displayName?.toLowerCase().includes(q) || m.name?.toLowerCase().includes(q)
                );
              })
              .map((model) => (
                <button
                  key={model.id}
                  onClick={() => {
                    setFields({ selectedModelId: model.id });
                    setShowModelMenu(false);
                    setModelSearchQuery("");
                  }}
                  className={cn(
                    "flex w-full items-center gap-3 rounded-xl border px-3.5 py-3 text-left transition",
                    selectedModelId === model.id
                      ? "border-emerald-400/40 bg-emerald-400/10"
                      : "border-white/10 bg-white/5 hover:bg-white/10",
                  )}
                >
                  {getProviderIcon(model.providerId)}
                  <div className="flex-1 min-w-0">
                    <span className="block truncate text-sm text-white">
                      {model.displayName || model.name}
                    </span>
                    <span className="block truncate text-xs text-white/40">{model.name}</span>
                  </div>
                  {selectedModelId === model.id && (
                    <Check className="h-4 w-4 shrink-0 text-emerald-400" />
                  )}
                </button>
              ))}
          </div>
        </div>
      </BottomMenu>

      {/* Voice Selection BottomMenu */}
      <BottomMenu
        isOpen={showVoiceMenu}
        onClose={() => {
          setShowVoiceMenu(false);
          setVoiceSearchQuery("");
        }}
        title="Select Voice"
      >
        <div className="space-y-4">
          <div className="relative">
            <input
              type="text"
              value={voiceSearchQuery}
              onChange={(e) => setVoiceSearchQuery(e.target.value)}
              placeholder="Search voices..."
              className="w-full rounded-xl border border-white/10 bg-black/30 px-4 py-2.5 pl-10 text-sm text-white placeholder-white/40 focus:border-white/20 focus:outline-none"
            />
            <svg
              className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-white/40"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>
          <div className="space-y-2 max-h-[50vh] overflow-y-auto">
            <button
              onClick={() => {
                setFields({ voiceConfig: null });
                setShowVoiceMenu(false);
                setVoiceSearchQuery("");
              }}
              className={cn(
                "flex w-full items-center gap-3 rounded-xl border px-3.5 py-3 text-left transition",
                !voiceSelectionValue
                  ? "border-emerald-400/40 bg-emerald-400/10"
                  : "border-white/10 bg-white/5 hover:bg-white/10",
              )}
            >
              <Volume2 className="h-5 w-5 text-white/40" />
              <span className="text-sm text-white">No voice assigned</span>
              {!voiceSelectionValue && <Check className="h-4 w-4 ml-auto text-emerald-400" />}
            </button>

            {/* User Voices */}
            {userVoices.length > 0 && (
              <MenuSection label="My Voices">
                {userVoices
                  .filter((v) => {
                    if (!voiceSearchQuery) return true;
                    return v.name.toLowerCase().includes(voiceSearchQuery.toLowerCase());
                  })
                  .map((voice) => {
                    const value = buildUserVoiceValue(voice.id);
                    const isSelected = voiceSelectionValue === value;
                    const providerLabel =
                      audioProviders.find((p) => p.id === voice.providerId)?.label ?? "Provider";
                    return (
                      <button
                        key={voice.id}
                        onClick={() => {
                          setFields({
                            voiceConfig: {
                              source: "user",
                              userVoiceId: voice.id,
                              providerId: voice.providerId,
                              modelId: voice.modelId,
                              voiceName: voice.name,
                            },
                          });
                          setShowVoiceMenu(false);
                          setVoiceSearchQuery("");
                        }}
                        className={cn(
                          "flex w-full items-center gap-3 rounded-xl border px-3.5 py-3 text-left transition",
                          isSelected
                            ? "border-emerald-400/40 bg-emerald-400/10"
                            : "border-white/10 bg-white/5 hover:bg-white/10",
                        )}
                      >
                        <User className="h-5 w-5 text-white/40" />
                        <div className="flex-1 min-w-0">
                          <span className="block truncate text-sm text-white">{voice.name}</span>
                          <span className="block truncate text-xs text-white/40">
                            {providerLabel}
                          </span>
                        </div>
                        {isSelected && <Check className="h-4 w-4 shrink-0 text-emerald-400" />}
                      </button>
                    );
                  })}
              </MenuSection>
            )}

            {/* Provider Voices */}
            {audioProviders.map((provider) => {
              const voices = (providerVoices[provider.id] ?? []).filter((v) => {
                if (!voiceSearchQuery) return true;
                return v.name.toLowerCase().includes(voiceSearchQuery.toLowerCase());
              });
              if (voices.length === 0) return null;
              return (
                <MenuSection key={provider.id} label={`${provider.label} Voices`}>
                  {voices.map((voice) => {
                    const value = buildProviderVoiceValue(provider.id, voice.voiceId);
                    const isSelected = voiceSelectionValue === value;
                    return (
                      <button
                        key={`${provider.id}:${voice.voiceId}`}
                        onClick={() => {
                          setFields({
                            voiceConfig: {
                              source: "provider",
                              providerId: provider.id,
                              voiceId: voice.voiceId,
                              voiceName: voice.name,
                            },
                          });
                          setShowVoiceMenu(false);
                          setVoiceSearchQuery("");
                        }}
                        className={cn(
                          "flex w-full items-center gap-3 rounded-xl border px-3.5 py-3 text-left transition",
                          isSelected
                            ? "border-emerald-400/40 bg-emerald-400/10"
                            : "border-white/10 bg-white/5 hover:bg-white/10",
                        )}
                      >
                        <Volume2 className="h-5 w-5 text-white/40" />
                        <span className="flex-1 truncate text-sm text-white">{voice.name}</span>
                        {isSelected && <Check className="h-4 w-4 shrink-0 text-emerald-400" />}
                      </button>
                    );
                  })}
                </MenuSection>
              );
            })}
          </div>
        </div>
      </BottomMenu>
    </div>
  );
}
